<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>活動報名系統｜活動詳情</title>
  <style>
    body { font-family: system-ui, -apple-system, "PingFang TC", "Noto Sans TC", sans-serif; margin: 24px; }
    a { color: inherit; }
    .card { border:1px solid #ddd; border-radius:12px; padding:16px; margin:12px 0; }
    .muted { color:#666; font-size:14px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    input, textarea { padding:10px; border-radius:10px; border:1px solid #ccc; width: min(520px, 100%); }
    button { padding:10px 12px; border-radius:10px; border:1px solid #aaa; background:#fff; cursor:pointer; }
    button.primary { border-color:#000; }
    button.danger { border-color:#c00; }
    .pill { display:inline-block; padding:2px 10px; border-radius:999px; border:1px solid #ccc; font-size:12px; }
    .pill.open { border-color:#0a0; color:#0a0; }
    .pill.closed { border-color:#999; color:#999; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align:left; vertical-align: top; }
    code { background: #f5f5f5; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="row" style="justify-content:space-between; align-items:center;">
    <div>
      <h1 style="margin:0;">活動詳情</h1>
      <div class="muted">本頁包含：Read 活動、Create 報名、Read 名單、Update 報名、Delete 取消</div>
    </div>
    <div class="row">
      <a href="index.html">← 回活動列表</a>
      <button id="btnReload">重新整理</button>
    </div>
  </div>

  <section class="card" id="eventBox">
    <div class="muted">載入中...</div>
  </section>

  <div class="row">
    <!-- register -->
    <section class="card" style="flex:1; min-width:320px;">
      <h2 style="margin-top:0;">我要報名（Create）</h2>
      <div class="muted">若同一活動同一 email 重複報名，後端會回 409。</div>

      <div style="margin-top:10px;">
        <div class="muted">姓名 name *</div>
        <input id="name" placeholder="例如：蔡琦浚" />
      </div>
      <div style="margin-top:10px;">
        <div class="muted">Email email *</div>
        <input id="email" placeholder="例如：leo@example.com" />
      </div>
      <div style="margin-top:10px;">
        <div class="muted">電話 phone</div>
        <input id="phone" placeholder="例如：0912345678" />
      </div>
      <div style="margin-top:10px;">
        <div class="muted">備註 note</div>
        <textarea id="note" rows="3" placeholder="例如：我會帶飲料"></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <button class="primary" id="btnRegister">送出報名</button>
        <span id="regMsg" class="muted"></span>
      </div>
    </section>

    <!-- list registrations -->
    <section class="card" style="flex:1; min-width:320px;">
      <h2 style="margin-top:0;">報名名單（Read）</h2>
      <div class="muted">名單來源：<code>GET /api/registrations?eventId=...</code></div>
      <div id="regList" style="margin-top:10px;"></div>
    </section>
  </div>

  <script>
    const API_BASE = "http://localhost:3000";
    const $ = (id) => document.getElementById(id);

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function getQuery(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    async function api(path, options = {}) {
      const res = await fetch(API_BASE + path, {
        headers: { "Content-Type": "application/json", ...(options.headers || {}) },
        ...options
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || `HTTP ${res.status}`);
      return data;
    }

    const eventId = getQuery("id");

    async function loadEvent() {
      const box = $("eventBox");
      if (!eventId) {
        box.innerHTML = `<div>缺少活動 id，請從 <a href="index.html">活動列表</a> 點進來。</div>`;
        return;
      }

      try {
        const result = await api(`/api/events/${encodeURIComponent(eventId)}`, { method: "GET" });
        const e = result.data;
        const pillClass = e.status === "open" ? "open" : "closed";

        box.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start; flex-wrap:wrap;">
            <div style="flex:1; min-width:260px;">
              <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
                <h2 style="margin:0;">${escapeHtml(e.title)}</h2>
                <span class="pill ${pillClass}">${escapeHtml(e.status)}</span>
              </div>
              <div class="muted">${escapeHtml(e.date)}｜${escapeHtml(e.location)}｜名額 ${escapeHtml(e.capacity)}</div>
              <div style="margin-top:8px;">${escapeHtml(e.description)}</div>
              <div class="muted" style="margin-top:8px;">活動ID：<code>${escapeHtml(e._id)}</code></div>
            </div>

            <div class="row" style="align-items:center;">
              <button onclick="toggleStatus('${e._id}', '${e.status}')">
                ${e.status === "open" ? "關閉活動（Update）" : "開放活動（Update）"}
              </button>
              <button class="danger" onclick="deleteEvent('${e._id}')">刪除活動（Delete）</button>
            </div>
          </div>
        `;
      } catch (err) {
        box.innerHTML = `<div class="muted">載入活動失敗：${escapeHtml(err.message)}</div>`;
      }
    }

    async function loadRegistrations() {
      const regList = $("regList");
      regList.innerHTML = `<div class="muted">載入名單中...</div>`;

      try {
        const result = await api(`/api/registrations?eventId=${encodeURIComponent(eventId)}`, { method: "GET" });
        const regs = result.data || [];

        if (!regs.length) {
          regList.innerHTML = `<div class="muted">尚無報名資料</div>`;
          return;
        }

        regList.innerHTML = `
          <table>
            <thead>
              <tr>
                <th>姓名</th>
                <th>Email</th>
                <th>電話/備註</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              ${regs.map(r => `
                <tr>
                  <td>${escapeHtml(r.name)}</td>
                  <td>${escapeHtml(r.email)}</td>
                  <td>
                    <div class="muted">phone: ${escapeHtml(r.phone || "-")}</div>
                    <div class="muted">note: ${escapeHtml(r.note || "-")}</div>
                    <div class="muted small">id: <code>${escapeHtml(r._id)}</code></div>
                  </td>
                  <td style="min-width:170px;">
                    <button onclick="editRegPrompt('${r._id}', '${escapeHtml(r.phone || "")}', '${escapeHtml(r.note || "")}')">修改（Update）</button>
                    <button class="danger" onclick="deleteReg('${r._id}')">取消（Delete）</button>
                  </td>
                </tr>
              `).join("")}
            </tbody>
          </table>
        `;
      } catch (err) {
        regList.innerHTML = `<div class="muted">載入名單失敗：${escapeHtml(err.message)}</div>`;
      }
    }

    async function register() {
      if (!eventId) return;

      $("regMsg").textContent = "送出中...";
      try {
        const body = {
          eventId,
          name: $("name").value.trim(),
          email: $("email").value.trim(),
          phone: $("phone").value.trim(),
          note: $("note").value.trim()
        };

        const result = await api("/api/registrations", {
          method: "POST",
          body: JSON.stringify(body)
        });

        $("regMsg").textContent = "✅ 報名成功";
        $("phone").value = "";
        $("note").value = "";

        await loadRegistrations();
      } catch (err) {
        $("regMsg").textContent = "❌ " + err.message;
      }
    }

    async function deleteReg(id) {
      if (!confirm("確定取消報名？")) return;
      try {
        await api(`/api/registrations/${encodeURIComponent(id)}`, { method: "DELETE" });
        await loadRegistrations();
      } catch (err) {
        alert("取消失敗：" + err.message);
      }
    }

    async function editRegPrompt(id, currentPhone, currentNote) {
      const phone = prompt("更新 phone（留空也可）", currentPhone);
      if (phone === null) return;
      const note = prompt("更新 note（留空也可）", currentNote);
      if (note === null) return;

      try {
        await api(`/api/registrations/${encodeURIComponent(id)}`, {
          method: "PUT",
          body: JSON.stringify({ phone, note })
        });
        await loadRegistrations();
      } catch (err) {
        alert("更新失敗：" + err.message);
      }
    }

    async function toggleStatus(id, current) {
      const next = current === "open" ? "closed" : "open";
      try {
        await api(`/api/events/${encodeURIComponent(id)}`, {
          method: "PUT",
          body: JSON.stringify({ status: next })
        });
        await loadEvent();
      } catch (err) {
        alert("更新狀態失敗：" + err.message);
      }
    }

    async function deleteEvent(id) {
      if (!confirm("確定刪除活動？（報名資料也會一起刪）")) return;
      try {
        await api(`/api/events/${encodeURIComponent(id)}`, { method: "DELETE" });
        alert("活動已刪除，回到列表頁");
        window.location.href = "index.html";
      } catch (err) {
        alert("刪除失敗：" + err.message);
      }
    }

    // expose
    window.deleteReg = deleteReg;
    window.editRegPrompt = editRegPrompt;
    window.toggleStatus = toggleStatus;
    window.deleteEvent = deleteEvent;

    $("btnRegister").addEventListener("click", register);
    $("btnReload").addEventListener("click", async () => {
      await loadEvent();
      await loadRegistrations();
    });

    (async function init() {
      await loadEvent();
      await loadRegistrations();
    })();
  </script>
</body>
</html>